# èŠå¤©æ¶ˆæ¯è¡¨æƒ…å›åº”ï¼ˆReactionï¼‰äº‘ç«¯åŒæ­¥æ¥å£éœ€æ±‚æ–‡æ¡£

## 1. ç›®çš„ä¸èŒƒå›´

æœ¬æ–‡æ¡£ç”¨äºå®šä¹‰ IM æ¶ˆæ¯è¡¨æƒ…å›åº”çš„äº‘ç«¯åŒæ­¥èƒ½åŠ›ï¼Œè¦†ç›–ï¼š

1. å•æ¡æ¶ˆæ¯æŒ‚è½½å¤šä¸ªè¡¨æƒ…ã€‚
2. æ¯ä¸ªè¡¨æƒ…æ”¯æŒå¤šäººå›åº”è®¡æ•°ã€‚
3. å‰ç«¯å¤šç«¯å®æ—¶ä¸€è‡´ï¼ˆå½“å‰ç«¯å·²å®Œæˆæœ¬åœ°è½åº“åï¼Œå¯¹æ¥äº‘ç«¯åŒæ­¥ï¼‰ã€‚

## 2. å½“å‰å‰ç«¯ç°çŠ¶ï¼ˆå·²å®Œæˆï¼‰

å½“å‰å®¢æˆ·ç«¯å·²æ”¯æŒï¼š

1. å³é”®ä»–äººæ¶ˆæ¯ï¼Œé€‰æ‹© `è¡¨æƒ…å›å¤`ã€‚
2. ä½¿ç”¨ EmojiPicker é€‰æ‹©åŸç”Ÿ/è‡ªå®šä¹‰è¡¨æƒ…ã€‚
3. æœ¬åœ°æ¶ˆæ¯æ¨¡å‹ `Message.reactions[]` æŒä¹…åŒ–åˆ°æœ¬åœ°æ•°æ®åº“å­—æ®µ `user_messages.reactions`ã€‚
4. ç»“æ„æ”¯æŒâ€œä¸€æ¡æ¶ˆæ¯å¤šä¸ªè¡¨æƒ…ã€æ¯ä¸ªè¡¨æƒ…å¤šä¸ªç”¨æˆ·â€ã€‚

è¯´æ˜ï¼šå½“å‰ä»…æœ¬åœ°ç”Ÿæ•ˆï¼Œå°šæœªæ¥æœåŠ¡ç«¯èšåˆä¸æ¨é€ã€‚

## 3. æ•°æ®æ¨¡å‹å®šä¹‰

## 3.1 ReactionItem

```json
{
  "key": "t:[è¡¨æƒ…0123]",
  "emoji": "[è¡¨æƒ…0123]",
  "imageUrl": "https://cdn.example.com/emoji/0123.png",
  "count": 3,
  "userIds": ["10001", "10002", "10003"],
  "updatedAt": "2026-02-21T12:00:00Z"
}
```

å­—æ®µçº¦æŸï¼š

1. `key` å…¨å±€å”¯ä¸€åˆ°â€œæ¶ˆæ¯å†…çš„æŸä¸ªè¡¨æƒ…ç±»å‹â€ï¼Œå»ºè®®æ ¼å¼ï¼š`u:<unicode>`ã€`t:<token>`ã€`i:<url-hash>`ã€‚
2. `count` å¿…é¡»ä¸ `userIds.length` ä¸€è‡´ã€‚
3. `emoji` ä¸ `imageUrl` è‡³å°‘æœ‰ä¸€ä¸ªéç©ºã€‚
4. `updatedAt` ä½¿ç”¨ ISO-8601 UTCã€‚

## 3.2 MessageReactionSnapshot

```json
{
  "chatId": 20010001,
  "messageId": 987654321,
  "serverMessageId": "msg_20260221_0001",
  "clientMessageId": "c_abc123",
  "reactions": []
}
```

æ¶ˆæ¯å®šä½è¦æ±‚ï¼š

1. ä¼˜å…ˆä½¿ç”¨ `serverMessageId`ã€‚
2. å›é€€ä½¿ç”¨ `chatId + messageId`ã€‚
3. å®¢æˆ·ç«¯å›æ˜¾é˜¶æ®µå¯ä¸´æ—¶ä½¿ç”¨ `clientMessageId`ã€‚

## 4. API æ¸…å•ï¼ˆP0ï¼‰

1. `PUT /messages/{messageId}/reactions/toggle`
2. `GET /messages/{messageId}/reactions`
3. WebSocket äº‹ä»¶ï¼š`message.reactions.updated`

## 5. æ¥å£è¯¦ç»†å®šä¹‰

## 5.1 PUT /messages/{messageId}/reactions/toggle

ç”¨é€”ï¼šå½“å‰ç”¨æˆ·å¯¹æŸè¡¨æƒ…æ‰§è¡Œâ€œåˆ‡æ¢â€ï¼ˆå·²ç‚¹åˆ™å–æ¶ˆï¼Œæœªç‚¹åˆ™æ·»åŠ ï¼‰ã€‚

è¯·æ±‚ä½“ï¼š

```json
{
  "chatId": 20010001,
  "serverMessageId": "msg_20260221_0001",
  "clientMessageId": "c_abc123",
  "reaction": {
    "key": "u:ğŸ‘",
    "emoji": "ğŸ‘",
    "imageUrl": null
  },
  "operatorId": "10001",
  "requestId": "req_20260221_001"
}
```

è¿”å›ï¼š

```json
{
  "code": 200,
  "status": "OK",
  "message": "success",
  "data": {
    "chatId": 20010001,
    "messageId": 987654321,
    "serverMessageId": "msg_20260221_0001",
    "reactions": []
  }
}
```

çº¦æŸï¼š

1. å¿…é¡»å¹‚ç­‰ï¼ŒåŸºäº `requestId` å»é‡ã€‚
2. è¿”å›å€¼å¿…é¡»æ˜¯â€œè¯¥æ¶ˆæ¯å®Œæ•´ reactions å¿«ç…§â€ï¼Œé¿å…å®¢æˆ·ç«¯å¢é‡åˆå¹¶æ­§ä¹‰ã€‚
3. `count` ä¸ `userIds` ç”±æœåŠ¡ç«¯ç»Ÿä¸€è®¡ç®—ã€‚

## 5.2 GET /messages/{messageId}/reactions

ç”¨é€”ï¼šæŒ‰éœ€æ‹‰å–å•æ¡æ¶ˆæ¯æœ€æ–° reactionsï¼ˆæ–­çº¿é‡è¿ã€è¡¥å¿åŒæ­¥ï¼‰ã€‚

Query å‚æ•°ï¼š

1. `chatId`ï¼ˆå¿…å¡«ï¼‰
2. `serverMessageId`ï¼ˆå»ºè®®ï¼‰
3. `clientMessageId`ï¼ˆå¯é€‰ï¼‰

è¿”å›ï¼š

1. `data` ä½¿ç”¨ `MessageReactionSnapshot`ã€‚

## 5.3 WebSocket äº‹ä»¶ `message.reactions.updated`

äº‹ä»¶ä½“ï¼š

```json
{
  "eventType": "message.reactions.updated",
  "chatId": 20010001,
  "messageId": 987654321,
  "serverMessageId": "msg_20260221_0001",
  "updatedAt": "2026-02-21T12:00:00Z",
  "reactions": []
}
```

æ¨é€è§„åˆ™ï¼š

1. åŒä¼šè¯åœ¨çº¿æˆå‘˜éƒ½åº”æ”¶åˆ°äº‹ä»¶ï¼ˆå«æ“ä½œè€…æœ¬äººï¼Œä¾¿äºå¤šç«¯ä¸€è‡´ï¼‰ã€‚
2. å®¢æˆ·ç«¯æ”¶åˆ°åä»¥å¿«ç…§è¦†ç›–æœ¬åœ°è¯¥æ¶ˆæ¯çš„ `reactions`ã€‚
3. `updatedAt` å•è°ƒé€’å¢ï¼Œç”¨äºå¿½ç•¥ä¹±åºæ—§äº‹ä»¶ã€‚

## 6. å¹‚ç­‰ä¸å¹¶å‘è§„åˆ™

1. åŒä¸€ `requestId` é‡è¯•ä¸å¾—é‡å¤è®¡æ•°ã€‚
2. å¹¶å‘ toggle å¿…é¡»ä»¥â€œç”¨æˆ·ç»´åº¦é›†åˆâ€è®¡ç®—ï¼ˆ`Set<userId>` è¯­ä¹‰ï¼‰ï¼Œç¦æ­¢ç›´æ¥åš `count +/- 1`ã€‚
3. æœåŠ¡ç«¯åº”ä¿è¯æœ€ç»ˆ `count === userIds.length`ã€‚

## 7. é‰´æƒä¸æƒé™

1. ä»…ä¼šè¯æˆå‘˜å¯æ“ä½œã€‚
2. ä¸å…è®¸å¯¹ä¸å­˜åœ¨æˆ–å·²åˆ é™¤æ¶ˆæ¯æ“ä½œã€‚
3. `operatorId` ä»¥é‰´æƒ token ä¸ºå‡†ï¼Œå¿½ç•¥å®¢æˆ·ç«¯ä¼ªé€ ã€‚

## 8. é”™è¯¯ç å»ºè®®

1. `400 REACTION_INVALID_PARAM`ï¼šå‚æ•°éæ³•æˆ–ç¼ºå¤±ã€‚
2. `401 UNAUTHORIZED`ï¼šæœªç™»å½•/ä»¤ç‰Œæ— æ•ˆã€‚
3. `403 MESSAGE_FORBIDDEN`ï¼šæ— æƒæ“ä½œè¯¥æ¶ˆæ¯ã€‚
4. `404 MESSAGE_NOT_FOUND`ï¼šæ¶ˆæ¯ä¸å­˜åœ¨ã€‚
5. `409 REACTION_STATE_CONFLICT`ï¼šæ¶ˆæ¯çŠ¶æ€å†²çªï¼ˆå¦‚å·²æ’¤å›ä¸å¯å›åº”ï¼‰ã€‚
6. `500 INTERNAL_ERROR`ï¼šæœåŠ¡ç«¯å¼‚å¸¸ã€‚

## 9. æ€§èƒ½ä¸å­˜å‚¨å»ºè®®

1. å•æ¶ˆæ¯ reaction ç±»å‹ä¸Šé™å»ºè®® `20`ã€‚
2. å• reaction çš„ `userIds` å»ºè®®ä¸Šé™ `500`ï¼ˆè¶…è¿‡ä»…è¿”å›å‰ N + countï¼‰ã€‚
3. P95 æ—¶å»¶ç›®æ ‡ï¼štoggle < 200msï¼Œsnapshot æŸ¥è¯¢ < 150msã€‚

ç´¢å¼•å»ºè®®ï¼š

1. `message_reactions(message_id, reaction_key)` å”¯ä¸€ç´¢å¼•ã€‚
2. `message_reaction_users(message_id, reaction_key, user_id)` å”¯ä¸€ç´¢å¼•ã€‚

## 10. éªŒæ”¶æ¸…å•

1. å¤šä¸ªç”¨æˆ·å¯å¯¹åŒä¸€æ¶ˆæ¯åŒä¸€è¡¨æƒ…å›åº”ï¼Œè®¡æ•°å‡†ç¡®ã€‚
2. åŒä¸€æ¶ˆæ¯æ”¯æŒå¤šä¸ªä¸åŒè¡¨æƒ…åŒæ—¶å­˜åœ¨ã€‚
3. å¤šç«¯åœ¨çº¿æ—¶ï¼ŒA ç«¯æ“ä½œå B ç«¯å¯åœ¨ 1s å†…æ”¶åˆ°æ›´æ–°å¹¶ä¸€è‡´å±•ç¤ºã€‚
4. å®¢æˆ·ç«¯æ–­çº¿é‡è¿åï¼Œ`GET` æ‹‰å–ç»“æœä¸æœåŠ¡ç«¯çŠ¶æ€ä¸€è‡´ã€‚
5. é‡å¤è¯·æ±‚ä¸ä¼šå¯¼è‡´è®¡æ•°è†¨èƒ€ã€‚
